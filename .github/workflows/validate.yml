name: Validate PKGBUILDs

on:
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Get changed packages
        id: changed
        run: |
          CHANGED_DIRS=$(git diff --name-only origin/main...HEAD | grep -E '^[^/]+/PKGBUILD$' | xargs -I {} dirname {} | sort -u || true)
          echo "dirs=$CHANGED_DIRS" >> "$GITHUB_OUTPUT"
          echo "Changed packages: $CHANGED_DIRS"

      - name: Validate PKGBUILDs
        if: steps.changed.outputs.dirs != ''
        env:
          CHANGED_DIRS: ${{ steps.changed.outputs.dirs }}
        run: |
          docker run --rm -v "$GITHUB_WORKSPACE":/workspace -w /workspace archlinux:base-devel bash -c '
            pacman -Syu --noconfirm namcap

            FAILED=0
            for dir in $0; do
              echo "== Validating $dir =="

              if [ ! -f "$dir/PKGBUILD" ]; then
                echo "PKGBUILD not found in $dir"
                continue
              fi

              echo "Running namcap..."
              namcap "$dir/PKGBUILD" || true

              if [ ! -f "$dir/.SRCINFO" ]; then
                echo "ERROR: .SRCINFO missing in $dir"
                FAILED=1
                continue
              fi

              cd "$dir"
              makepkg --printsrcinfo > .SRCINFO.new
              if ! diff -q .SRCINFO .SRCINFO.new > /dev/null 2>&1; then
                echo "ERROR: .SRCINFO is outdated in $dir"
                echo "Run: makepkg --printsrcinfo > .SRCINFO"
                diff .SRCINFO .SRCINFO.new || true
                FAILED=1
              else
                echo ".SRCINFO is up to date"
              fi
              rm -f .SRCINFO.new
              cd /workspace
            done

            exit $FAILED
          ' "$CHANGED_DIRS"

      - name: No changes
        if: steps.changed.outputs.dirs == ''
        run: echo "No PKGBUILD changes detected"
